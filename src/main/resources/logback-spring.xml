<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <include resource="org/springframework/boot/logging/logback/console-appender.xml"/>

    <!-- Production profile: ship logs to Logstash and console -->
    <springProfile name="prod">
        <if condition='property("LOGSTASH_ENABLED").equalsIgnoreCase("true")'>
            <then>
                <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
                    <destination>${LOGSTASH_HOST:-logstash}:${LOGSTASH_PORT:-5000}</destination>
                    <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                        <customFields>{"app":"games-backend","environment":"prod"}</customFields>
                    </encoder>
                </appender>
            </then>
        </if>

        <root level="INFO">
            <!-- Only attach if enabled -->
            <if condition='property("LOGSTASH_ENABLED").equalsIgnoreCase("true")'>
                <then>
                    <appender-ref ref="LOGSTASH"/>
                </then>
            </if>
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- Development profile: verbose console logging -->
    <springProfile name="dev">
        <root level="DEBUG">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- Default/local/test/Cloud profiles: log to console only with INFO level -->
    <springProfile name="default,local,test,cloud">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- Framework logging (turn down noisy frameworks) -->
    <logger name="org.springframework" level="WARN"/>
    <logger name="org.springframework.web" level="WARN"/>
    <logger name="org.springframework.security" level="WARN"/>
    <logger name="org.apache.coyote" level="WARN"/>
    <logger name="org.apache.tomcat" level="WARN"/>
    <logger name="reactor.netty" level="WARN"/>
    <logger name="io.netty" level="WARN"/>
    <logger name="org.hibernate" level="WARN"/>
    <logger name="org.hibernate.SQL" level="ERROR"/>
    <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="ERROR"/>
    <logger name="org.hibernate.orm.jdbc.bind" level="ERROR"/>

    <!-- Application logging: default to INFO in all profiles unless overridden -->
    <logger name="com.games" level="INFO"/>

    <!-- Reduce Mockito logging noise -->
    <logger name="org.mockito" level="WARN"/>
    <logger name="org.mockito.internal" level="ERROR"/>
    <logger name="net.bytebuddy" level="ERROR"/>

    <!-- Disable specific noisy Mockito messages -->
    <logger name="org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker" level="OFF"/>
    <logger name="org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker" level="OFF"/>
</configuration>
