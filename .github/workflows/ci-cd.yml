name: CI/CD â€” GameHub API (Cloud Run)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  AR_REPO: ${{ vars.AR_REPO || 'gamehub' }}
  BACKEND_SERVICE: ${{ vars.BACKEND_SERVICE || 'gamehub-api' }}

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Unit tests (fast only)
        run: mvn -B -Dtest="*Test" test

      - name: Package (skip ITs)
        run: mvn -B -DskipTests package

      - name: Set build metadata
        id: meta
        run: |
          echo "sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "region=${{ secrets.GCP_REGION }}" >> $GITHUB_OUTPUT
          echo "project=${{ secrets.GCP_PROJECT_ID }}" >> $GITHUB_OUTPUT

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ steps.meta.outputs.region }}-docker.pkg.dev --quiet

      - name: Build and Push Image
        env:
          REGION: ${{ steps.meta.outputs.region }}
          PROJECT: ${{ steps.meta.outputs.project }}
          AR_REPO: ${{ env.AR_REPO }}
          SERVICE: ${{ env.BACKEND_SERVICE }}
          SHA: ${{ steps.meta.outputs.sha }}
        run: |
          IMAGE="$REGION-docker.pkg.dev/$PROJECT/$AR_REPO/$SERVICE:$SHA"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker build -t "$IMAGE" -f Dockerfile .
          docker push "$IMAGE"

      - name: Optional Docker Hub Push
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          SERVICE: ${{ env.BACKEND_SERVICE }}
          SHA: ${{ steps.meta.outputs.sha }}
        run: |
          set -e
          if [ -n "$DOCKERHUB_USERNAME" ] && [ -n "$DOCKERHUB_TOKEN" ]; then
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker tag "$IMAGE" "$DOCKERHUB_USERNAME/$SERVICE:$SHA"
            docker tag "$IMAGE" "$DOCKERHUB_USERNAME/$SERVICE:latest"
            docker push "$DOCKERHUB_USERNAME/$SERVICE:$SHA"
            docker push "$DOCKERHUB_USERNAME/$SERVICE:latest"
          else
            echo "Docker Hub secrets not set; skipping Docker Hub push."
          fi

      - name: Deploy to Cloud Run
        env:
          REGION: ${{ steps.meta.outputs.region }}
          PROJECT: ${{ steps.meta.outputs.project }}
          SERVICE: ${{ env.BACKEND_SERVICE }}
          IMAGE: ${{ env.IMAGE }}
          SECRET_FLAGS: ${{ secrets.SECRET_FLAGS }}
          FRONTEND_URL: ${{ vars.FRONTEND_URL }}
          INSTANCE_CONNECTION_NAME: ${{ vars.INSTANCE_CONNECTION_NAME }}
          VPC_CONNECTOR: ${{ vars.VPC_CONNECTOR }}
        run: |
          set -e
          EXTRA_SECRETS=""
          if [ -n "$SECRET_FLAGS" ]; then
            EXTRA_SECRETS="--set-secrets \"$SECRET_FLAGS\""
          fi
          CORS_ORIGINS=${FRONTEND_URL:-"*"}
          ADD_CLOUDSQL=""
          if [ -n "$INSTANCE_CONNECTION_NAME" ]; then
            ADD_CLOUDSQL="--add-cloudsql-instances $INSTANCE_CONNECTION_NAME"
          fi
          VPC_FLAG=""
          if [ -n "$VPC_CONNECTOR" ]; then
            VPC_FLAG="--vpc-connector $VPC_CONNECTOR"
          fi
          gcloud run deploy "$SERVICE" \
            --region="$REGION" \
            --image="$IMAGE" \
            --allow-unauthenticated \
            --port=8080 \
            --set-env-vars SPRING_PROFILES_ACTIVE=prod,CORS_ALLOWED_ORIGINS="$CORS_ORIGINS" \
            $ADD_CLOUDSQL \
            $VPC_FLAG \
            ${EXTRA_SECRETS}

      - name: Post-deploy health checks
        env:
          REGION: ${{ steps.meta.outputs.region }}
          SERVICE: ${{ env.BACKEND_SERVICE }}
        run: |
          URL=$(gcloud run services describe "$SERVICE" --region "$REGION" --format='value(status.url)')
          echo "Service URL: $URL"
          curl -fsS "$URL/healthz" -o /dev/null && echo "healthz OK" || (echo "healthz failed" && exit 1)
          curl -fsS "$URL/actuator/health" -o /dev/null && echo "actuator OK" || (echo "actuator failed" && exit 1)
